<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">随机选择器 - 自定义次数</title>
    <style>
        /* 基础样式 */
        :root {
            --primary: #4F46E5;
            --secondary: #10B981;
            --accent: #8B5CF6;
            --neutral: #1F2937;
            --bg-light: #f9fafb;
            --bg-white: #ffffff;
            --text-dark: #1F2937;
            --text-gray: #6B7280;
            --border-light: #E5E7EB;
            /* 响应式相关变量 */
            --spacing-xs: 0.25rem;
            --spacing-sm: 0.5rem;
            --spacing-md: 1rem;
            --spacing-lg: 1.5rem;
            --spacing-xl: 2rem;
            --border-radius: 0.75rem;
            --input-height: 2.75rem;
        }
        
        /* 深色模式变量 - 保持色调一致，调整亮度和对比度 */
        :root.dark-theme {
            --primary: #6366f1; /* 比浅色模式稍亮的紫色 */
            --secondary: #34d399; /* 比浅色模式稍亮的绿色 */
            --accent: #a78bfa; /* 比浅色模式稍亮的粉色 */
            --bg-light: #0f172a; /* 深蓝黑色背景 */
            --bg-white: #1e293b; /* 卡片深色背景 */
            --text-dark: #f1f5f9; /* 浅色文本 */
            --text-gray: #cbd5e1; /* 灰色文本 */
            --border-light: #334155; /* 深色边框 */
            --shadow: 0 2px 15px rgba(0, 0, 0, 0.5);
            --success-bg: #064e3b;
            --success-text: #a7f3d0;
            --error-bg: #4c1d95;
            --error-text: #f9a8d4;
            --info-bg: #1e3a8a;
            --info-text: #bfdbfe;
        }
        
        /* 深色模式适配 */
        :root.dark-theme .options-list {
            background-color: #273449;
            border-color: var(--border-light);
        }
        
        :root.dark-theme .option-item {
            background-color: var(--bg-white);
            border-color: var(--border-light);
        }
        
        :root.dark-theme .option-item:hover {
            background-color: #273449;
        }
        
        :root.dark-theme .progress-bar {
            background-color: #334155;
        }
        
        /* 深色模式下的输入框样式 */
        :root.dark-theme input[type="text"]:focus,
        :root.dark-theme input[type="number"]:focus {
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* 深色模式下的消息提示样式 */
        :root.dark-theme .message-error {
            background-color: var(--error-bg);
            color: var(--error-text);
            border-color: rgba(236, 72, 153, 0.3);
        }
        
        :root.dark-theme .message-info {
            background-color: var(--info-bg);
            color: var(--info-text);
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        /* 深色模式下的渐变背景 */
        :root.dark-theme .bg-info {
            background: linear-gradient(to right, rgba(99, 102, 241, 0.1), rgba(167, 139, 250, 0.1));
            border-color: rgba(99, 102, 241, 0.2);
        }
        
        /* 深色模式下的文本颜色 */
        :root.dark-theme .text-gray-600,
        :root.dark-theme .text-gray-700,
        :root.dark-theme .text-gray-500 {
            color: var(--text-gray) !important;
        }
        
        :root.dark-theme .text-neutral {
            color: var(--text-dark) !important;
        }
        
        /* 深色模式下的按钮样式优化 */
        :root.dark-theme .btn-text:hover {
            color: #f472b6; /* 粉色悬停色 */
        }
        
        /* 深色模式下的卡片阴影 */
        :root.dark-theme .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
        }
        
        :root.dark-theme .card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.5;
            min-height: 100vh;
            /* 优化移动端触摸滚动 */
            -webkit-tap-highlight-color: transparent;
            -webkit-overflow-scrolling: touch;
        }
        
        /* 确保深色模式下body样式正确应用 */
        :root.dark-theme body {
            background-color: var(--bg-light);
            color: var(--text-dark);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* 卡片样式 */
        .card {
            background: var(--bg-white);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            padding: 1.5rem;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        
        /* 布局样式 */
        .grid {
            display: grid;
            gap: 1.5rem;
        }
        
        @media (min-width: 768px) {
            .grid-cols-12 {
                grid-template-columns: repeat(12, 1fr);
            }
            
            .md-col-span-5 {
                grid-column: span 5;
            }
            
            .md-col-span-7 {
                grid-column: span 7;
            }
        }
        
        /* 移动端响应式优化 */
        @media (max-width: 768px) {
            .card {
                padding: var(--spacing-md);
            }
            
            .options-list {
                max-height: 180px;
            }
            
            .progress-bar {
                height: 1rem;
            }
            
            /* 调整标题大小 */
            h1 {
                font-size: 1.75rem !important;
            }
            
            h2 {
                font-size: 1.25rem !important;
            }
            
            /* 增强进度条动画效果 */
            .progress-fill {
                transition: width 0.8s ease;
            }
            
            /* 调整主题按钮大小 */
            .theme-toggle {
                width: 3.25rem !important;
                height: 3.25rem !important;
                top: 1rem;
                right: 1rem;
            }
        }
        
        /* 小屏幕优化 */
        @media (max-width: 480px) {
            .container {
                padding: 0.75rem;
            }
            
            /* 按钮组堆叠显示 */
            .flex.space-x-2 {
                flex-direction: column;
                gap: var(--spacing-sm);
            }
            
            .flex.space-x-2 > * {
                margin-left: 0;
                margin-bottom: var(--spacing-sm);
            }
            
            /* 结果项间距调整 */
            .result-item {
                margin-bottom: var(--spacing-md);
            }
        }
        
        /* 按钮样式 */
        button {
            cursor: pointer;
            font-family: inherit;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-weight: 500;
            transition: all 0.2s ease;
            min-height: 2.5rem;
            box-sizing: border-box;
        }
        
        /* 移动端优化：提高触摸区域 */
        @media (hover: none) and (pointer: coarse) {
            button,
            .btn,
            .option-item,
            .cache-item {
                min-height: 3rem;
                padding: 0.75rem 1rem;
            }
            
            /* 防止iOS缩放问题 */
            input[type="number"] {
                -webkit-appearance: textfield;
                -moz-appearance: textfield;
                appearance: textfield;
            }
            
            /* 增强按钮触摸反馈 */
            button:active,
            .btn:active,
            .option-item:active,
            .cache-item:active {
                transform: scale(0.98);
                transition: transform 0.1s;
            }
        }
        
        /* 主题切换按钮样式 */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--bg-white);
            border: 1px solid var(--border-light);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .theme-toggle svg {
            width: 24px;
            height: 24px;
            fill: var(--text-dark);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background-color: var(--accent);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: rgba(139, 92, 246, 0.9);
        }
        
        .btn-text {
            background: none;
            color: var(--text-gray);
            padding: 0.5rem;
        }
        
        .btn-text:hover {
            color: #EF4444;
        }
        
        .btn-text:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 输入框样式 */
        input[type="text"],
        input[type="number"] {
            width: 100%;
            height: var(--input-height);
            padding: 0.75rem;
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s ease;
            background-color: var(--bg-white);
            color: var(--text-dark);
            box-sizing: border-box;
        }
        
        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        /* 列表和容器样式 */
        .options-list {
            border: 1px solid var(--border-light);
            border-radius: 0.5rem;
            padding: 0.5rem;
            min-height: 150px;
            max-height: 200px;
            overflow-y: auto;
            background-color: #F9FAFB;
        }
        
        .options-list::-webkit-scrollbar {
            display: none;
        }
        
        .options-list {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-white);
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.2s ease;
        }
        
        .option-item:hover {
            background-color: #F9FAFB;
        }
        
        .result-item {
            margin-bottom: 1rem;
        }
        
        .progress-bar {
            height: 1.25rem;
            background-color: #F3F4F6;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 1.5s ease-out;
        }
        
        .bg-primary {
            background-color: var(--primary);
        }
        
        .bg-secondary {
            background-color: var(--secondary);
        }
        
        .bg-accent {
            background-color: var(--accent);
        }
        
        .bg-gradient-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
        }
        
        /* 文本样式 */
        .text-center {
            text-align: center;
        }
        
        .text-gray {
            color: var(--text-gray);
        }
        
        .text-primary {
            color: var(--primary);
        }
        
        .text-secondary {
            color: var(--secondary);
        }
        
        .text-accent {
            color: var(--accent);
        }
        
        .font-bold {
            font-weight: 700;
        }
        
        .font-semibold {
            font-weight: 600;
        }
        
        .font-medium {
            font-weight: 500;
        }
        
        .text-lg {
            font-size: 1.125rem;
        }
        
        .text-xl {
            font-size: 1.25rem;
        }
        
        .text-sm {
            font-size: 0.875rem;
        }
        
        /* 间距样式 */
        .mb-2 {
            margin-bottom: 0.5rem;
        }
        
        .mb-4 {
            margin-bottom: 1rem;
        }
        
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        
        .mb-8 {
            margin-bottom: 2rem;
        }
        
        .mt-4 {
            margin-top: 1rem;
        }
        
        .mt-8 {
            margin-top: 2rem;
        }
        
        .mt-12 {
            margin-top: 3rem;
        }
        
        .p-2 {
            padding: 0.5rem;
        }
        
        .p-3 {
            padding: 0.75rem;
        }
        
        .p-4 {
            padding: 1rem;
        }
        
        .p-6 {
            padding: 1.5rem;
        }
        
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        
        .py-4 {
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        .py-8 {
            padding-top: 2rem;
            padding-bottom: 2rem;
        }
        
        .px-3 {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        
        /* 弹性布局 */
        .flex {
            display: flex;
        }
        
        .items-center {
            align-items: center;
        }
        
        .justify-between {
            justify-content: space-between;
        }
        
        .justify-center {
            justify-content: center;
        }
        
        .space-x-2 > * + * {
            margin-left: 0.5rem;
        }
        
        .space-y-2 > * + * {
            margin-top: 0.5rem;
        }
        
        .space-y-4 > * + * {
            margin-top: 1rem;
        }
        
        .space-y-5 > * + * {
            margin-top: 1.25rem;
        }
        
        .space-y-6 > * + * {
            margin-top: 1.5rem;
        }
        
        /* 阴影和圆角 */
        .rounded-lg {
            border-radius: 0.5rem;
        }
        
        .rounded-xl {
            border-radius: 0.75rem;
        }
        
        .rounded-full {
            border-radius: 9999px;
        }
        
        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* 自定义样式 */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 1.5rem;
            width: 1.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
        }
        
        .badge-primary {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--primary);
        }
        
        .badge-gold {
            background-color: rgba(252, 211, 77, 0.1);
            color: #CA8A04;
        }
        
        .badge-silver {
            background-color: rgba(209, 213, 219, 0.1);
            color: #6B7280;
        }
        
        .badge-bronze {
            background-color: rgba(245, 158, 11, 0.1);
            color: #B45309;
        }
        
        .badge-gray {
            background-color: rgba(209, 213, 219, 0.1);
            color: #6B7280;
        }
        
        .w-full {
            width: 100%;
        }
        
        .flex-1 {
            flex: 1;
        }
        
        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(90deg, var(--primary), var(--accent));
        }
        
        /* 渐变背景 */
        .bg-info {
            background: linear-gradient(to right, rgba(79, 70, 229, 0.05), rgba(139, 92, 246, 0.05));
            border: 1px solid rgba(79, 70, 229, 0.1);
        }
        
        /* 消息提示样式 */
        .message-error {
            background-color: #FEF2F2;
            color: #DC2626;
            border: 1px solid #FEE2E2;
        }
        
        .message-info {
            background-color: #EFF6FF;
            color: #2563EB;
            border: 1px solid #DBEAFE;
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
    </head>
    <body>
        <!-- 主题切换按钮 -->
        <button id="themeToggle" class="theme-toggle" aria-label="切换深色/浅色模式">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path id="themeIcon" d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06z"/>
            </svg>
        </button>
        
        <!-- 语言切换按钮 -->
        <button id="langToggle" class="theme-toggle" style="right: 70px;" aria-label="切换语言">
            <span id="langText" style="color: var(--text-dark); font-size: 14px; font-weight: bold;">中文</span>
        </button>
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 页面标题 -->
        <header class="text-center mb-8">
            <div class="inline-block p-3 rounded-full bg-primary/10 mb-4">
                <span class="text-3xl text-primary">🎲</span>
            </div>
            <h1 id="headerTitle" class="text-[clamp(2rem,5vw,3rem)] font-bold text-gradient mb-2">随机选择器</h1>
            <p id="headerSubtitle" class="text-gray-600 text-lg">高效添加选项，自定义随机次数，快速获取结果</p>
        </header>

        <div class="grid md:grid-cols-12 gap-6">
            <!-- 左侧输入区域 -->
            <div class="md:col-span-5 bg-white rounded-xl shadow-card p-6 card">
                <h2 id="addOptionsTitle" class="text-xl font-semibold mb-4 flex items-center text-neutral">
                    <span class="text-accent mr-2">📋</span>添加选项
                </h2>
                <p id="addOptionsSubtitle" class="text-gray-600 mb-4 text-sm">逐个添加选项，添加完成后点击"开始随机选择"</p>
                
                <div class="space-y-4">
                    <!-- 单选项输入框和添加按钮 -->
                    <div class="flex space-x-2">
                        <input 
                            id="singleOptionInput" 
                            type="text" 
                            class="flex-1 p-3 shadow-sm"
                            placeholder="输入一个选项..." autocomplete="off">
                        <button 
                            id="addOptionBtn" 
                            class="btn-secondary flex items-center justify-center whitespace-nowrap shadow-sm hover:shadow-md">
                            <span class="mr-2">+</span>添加选项
                        </button>
                    </div>
                    
                    <!-- 随机次数设置 -->
                    <div class="mt-4">
                        <label for="randomTimesInput" id="randomTimesLabel" class="block text-sm font-medium text-gray-700 mb-1">随机次数</label>
                        <div class="flex space-x-2">
                            <input 
                                id="randomTimesInput" 
                                type="number" 
                                min="1" 
                                max="10000" 
                                value="100" 
                                class="flex-1 p-3 shadow-sm"
                                autocomplete="off">
                            <div class="bg-gray-50 px-3 py-3 rounded-lg border border-gray-200 text-gray-500 text-sm flex items-center">
                                次
                            </div>
                        </div>
                    </div>
                    
                    <!-- 功能按钮组 -->
                    <div class="flex space-x-2">
                        <button 
                            id="exportOptionsBtn" 
                            class="btn-text text-sm flex-1 flex items-center justify-center"
                            disabled>
                            <span class="mr-1">📥</span>导出选项
                        </button>
                        <button 
                            id="importOptionsBtn" 
                            class="btn-text text-sm flex-1 flex items-center justify-center"
                            title="点击导入选项文件">
                            <span class="mr-1">📤</span>导入选项
                        </button>
                        <button 
                            id="clearOptionsBtn" 
                            class="btn-text text-sm flex-1 flex items-center justify-center"
                            disabled>
                            <span class="mr-1">🗑️</span>清空
                        </button>
                        
                        <!-- 隐藏的文件输入 -->
                        <input 
                            type="file" 
                            id="importFileInput" 
                            accept=".txt,.json" 
                            style="display: none;">
                    </div>
                    
                    <!-- 已添加选项列表 -->
                    <div id="optionsList" class="options-list">
                    <p id="emptyOptionsText" class="text-gray text-center text-sm py-8">暂无选项，请添加至少两个选项</p>
                </div>
                </div>
                
                <button 
                    id="startBtn" 
                    class="w-full btn-primary flex items-center justify-center shadow-sm hover:shadow-md mt-4">
                    <span class="mr-2">▶️</span>开始随机选择
                </button>
            </div>

            <!-- 右侧结果展示区域 -->
            <div class="md:col-span-7 bg-white rounded-xl shadow-card p-6 card">
                <h2 id="resultsTitle" class="text-xl font-semibold mb-4 flex items-center text-neutral">
                    <span class="text-secondary mr-2">📊</span>随机结果统计
                </h2>
                
                <div id="resultsContainer" class="min-h-[300px] flex items-center justify-center text-gray-500">
                    <p id="resultsPlaceholder" class="text-center">请在左侧输入选项并点击开始按钮</p>
                </div>
            </div>
        </div>

        <!-- 说明信息 -->
        <div class="mt-8 bg-gradient-to-r from-primary/5 to-accent/5 border border-primary/10 p-4 rounded-xl">
            <h3 class="font-semibold text-primary flex items-center">
                <span class="mr-2">ℹ️</span>使用说明
            </h3>
            <ul class="mt-2 text-gray-700 list-disc list-inside space-y-1 text-sm">
                <li>在输入框中输入选项内容，点击"添加选项"按钮或按Enter键添加</li>
                <li>您可以随时删除已添加的选项</li>
                <li>至少需要添加2个选项才能进行随机选择</li>
                <li>设置随机次数，点击"开始随机选择"按钮后，系统会从您添加的选项中随机选择指定次数</li>
                <li>右侧会显示每个选项被选中的次数、百分比以及可视化图表</li>
            </ul>
        </div>

        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>纯黑蓝&高效随机选择器 &copy; 2025 - 快速、公平、可视化</p>
        </footer>
    </div>

    <script>
        // 主题切换功能
        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            
            // 检查本地存储中的主题偏好
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark-theme');
                themeIcon.setAttribute('d', 'M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z');
            } else {
                themeIcon.setAttribute('d', 'M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06z');
            }
            
            // 主题切换事件监听
            themeToggle.addEventListener('click', function() {
                document.documentElement.classList.toggle('dark-theme');
                
                if (document.documentElement.classList.contains('dark-theme')) {
                    localStorage.setItem('theme', 'dark');
                    themeIcon.setAttribute('d', 'M20 8.69V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12 20 8.69zM12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm0-10c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z');
                } else {
                    localStorage.setItem('theme', 'light');
                    themeIcon.setAttribute('d', 'M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.55 0 1-.45 1-1s-.45-1-1-1H2c-.55 0-1 .45-1 1s.45 1 1 1zm18 0h2c.55 0 1-.45 1-1s-.45-1-1-1h-2c-.55 0-1 .45-1 1s.45 1 1 1zM11 2v2c0 .55.45 1 1 1s1-.45 1-1V2c0-.55-.45-1-1-1s-1 .45-1 1zm0 18v2c0 .55.45 1 1 1s1-.45 1-1v-2c0-.55-.45-1-1-1s-1 .45-1 1zM5.99 4.58c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41L5.99 4.58zm12.37 12.37c-.39-.39-1.03-.39-1.41 0-.39.39-.39 1.03 0 1.41l1.06 1.06c.39.39 1.03.39 1.41 0 .39-.39.39-1.03 0-1.41l-1.06-1.06zm1.06-10.96c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06zM7.05 18.36c.39-.39.39-1.03 0-1.41-.39-.39-1.03-.39-1.41 0l-1.06 1.06c-.39.39-.39 1.03 0 1.41.39.39 1.03.39 1.41 0l1.06-1.06z');
                }
            });
        }
        
        // 语言包定义
        const translations = {
            'zh-CN': {
                pageTitle: '随机选择器 - 自定义次数',
                headerTitle: '随机选择器',
                headerSubtitle: '高效添加选项，自定义随机次数，快速获取结果',
                addOptionsTitle: '添加选项',
                addOptionsSubtitle: '逐个添加选项，添加完成后点击"开始随机选择"',
                optionPlaceholder: '输入一个选项...',
                addOptionButton: '添加选项',
                randomTimesLabel: '随机次数',
                timesUnit: '次',
                exportOptionsButton: '导出选项',
                importOptionsButton: '导入选项',
                clearButton: '清空',
                importOptionsTitle: '导入选项',
                importOptionsDesc: '请上传包含选项的文本文件或JSON文件。文本文件每行一个选项。',
                startButton: '开始随机选择',
                resultsTitle: '随机结果统计',
                noOptionsMessage: '暂无选项，请添加至少两个选项',
                noResultsMessage: '请在左侧输入选项并点击开始按钮',
                useInstructionsTitle: '使用说明',
                useInstruction1: '在输入框中输入选项内容，点击"添加选项"按钮或按Enter键添加',
                useInstruction2: '您可以随时删除已添加的选项',
                useInstruction3: '至少需要添加2个选项才能进行随机选择',
                useInstruction4: '设置随机次数，点击"开始随机选择"按钮后，系统会从您添加的选项中随机选择指定次数',
                useInstruction5: '右侧会显示每个选项被选中的次数、百分比以及可视化图表',
                footerText: '纯黑蓝&高效随机选择器 &copy; 2025 - 快速、公平、可视化',
                langText: '中文',
                themeToggleAria: '切换深色/浅色模式',
                langToggleAria: '切换语言',
                percentLabel: '%',
                timesLabel: '次',
                emptyOptionsMessage: '请添加至少两个选项',
                importSuccessMessage: '成功导入 {count} 个选项',
                importErrorMessage: '导入失败，请检查文件格式',
                exportConfirmMessage: '选项已复制到剪贴板',
                clearConfirmMessage: '确定要清空所有选项吗？',
                calculatingMessage: '正在计算...',
                emptyOptionError: '请输入选项内容',
                optionTooLongError: '选项内容不能超过50个字符',
                duplicateOptionError: '该选项已存在，请输入其他选项',
                noOptionsToClear: '没有可清空的选项',
                confirmClearOptions: '确定要清空所有选项吗？',
                optionsCleared: '选项已清空',
                noOptionsToExport: '没有可导出的选项',
                optionsExported: '选项已导出',
                addOptionFirstError: '请先添加至少一个选项',
                countTooLowError: '随机次数不能小于1',
                largeCountWarning: '随机次数过多可能导致浏览器卡顿，确定要继续吗？',
                cacheFoundMessage: '发现了与当前选项相同的缓存结果（{randomCount}次随机）\n选项: {optionCount}个\n是否使用缓存结果？',
                confirmClearCache: '确定要清除所有历史缓存吗？',
                cacheCleared: '缓存已清除',
                cacheClearFailed: '清除缓存失败',
                noImportHistory: '暂无导入历史',
                cannotLoadImportHistory: '无法加载导入历史',
                importFileProcessing: '正在处理导入文件...',
                noValidOptionsInImport: '导入的文件中没有有效的选项',
                invalidImportFormat: '导入的文件格式不正确，缺少options字段',
                confirmMergeImportedOptions: '是否将导入的选项与现有选项合并？\n{previewMessage}{settingsMessage}',
                confirmMergePastedOptions: '是否将粘贴的配置与现有选项合并？\n{settingsMessage}',
                mergeImportSuccess: '成功导入并合并 {newCount} 个选项，当前共有 {totalCount} 个选项',
                importWithSettingsSuccess: '成功导入 {count} 个选项，并自动应用配置设置',
                importSuccess: '成功导入 {count} 个选项',
                pasteSuccessWithSettings: '成功粘贴 {count} 个选项，并自动应用配置设置',
                pasteSuccess: '成功粘贴 {count} 个选项',
                pasteWithMergeSuccess: '成功粘贴并合并 {newCount} 个选项，当前共有 {totalCount} 个选项',
                noValidOptionsInPaste: '粘贴的内容中没有有效的选项',
                confirmUpdateRandomTimes: '是否更新随机次数设置？',
                fileReadFailed: '文件读取失败，请确保文件未被损坏',
                importFileHelp: '支持 JSON 和纯文本格式\nJSON 格式可包含完整配置\n纯文本格式每行或用逗号分隔一个选项',
                noCacheHistory: '暂无缓存历史',
                currentResult: '当前结果',
                clickToRestore: '点击恢复',
                olderRecords: '还有 {count} 条更早的记录',
                expandCache: '展开全部记录',
                collapseCache: '收起记录',
                showAllRecords: '展开全部记录',
                hideOlderRecords: '收起记录',
                exportFileName: '随机选择器配置',
                importHistoryTitle: '导入历史',
                totalSelectionsLabel: '总选择次数：',
                optionCountLabel: '选项数量：'
            },
            'en-US': {
                pageTitle: 'Random Selector - Custom Times',
                headerTitle: 'Random Selector',
                headerSubtitle: 'Efficiently add options, customize random times, get results quickly',
                addOptionsTitle: 'Add Options',
                addOptionsSubtitle: 'Add options one by one, then click "Start Random Selection"',
                optionPlaceholder: 'Enter an option...',
                addOptionButton: 'Add Option',
                randomTimesLabel: 'Random Times',
                timesUnit: 'times',
                exportOptionsButton: 'Export Options',
                importOptionsButton: 'Import Options',
                clearButton: 'Clear',
                importOptionsTitle: 'Import Options',
                importOptionsDesc: 'Please upload a text file or JSON file containing options. Each line in text files represents one option.',
                startButton: 'Start Random Selection',
                resultsTitle: 'Random Results Statistics',
                noOptionsMessage: 'No options yet, please add at least two options',
                noResultsMessage: 'Please enter options on the left and click the start button',
                useInstructionsTitle: 'Instructions',
                useInstruction1: 'Enter option content in the input box, click "Add Option" button or press Enter to add',
                useInstruction2: 'You can delete added options at any time',
                useInstruction3: 'At least 2 options are required for random selection',
                useInstruction4: 'Set random times, click "Start Random Selection" button, the system will randomly select from your added options for the specified times',
                useInstruction5: 'The right side will show the number of times each option was selected, percentage, and visual chart',
                footerText: 'Pure Black Blue & Efficient Random Selector &copy; 2025 - Fast, Fair, Visual',
                langText: 'English',
                themeToggleAria: 'Toggle dark/light mode',
                langToggleAria: 'Toggle language',
                percentLabel: '%',
                timesLabel: 'times',
                emptyOptionsMessage: 'Please add at least two options',
                importSuccessMessage: 'Successfully imported {count} options',
                importErrorMessage: 'Import failed, please check file format',
                exportConfirmMessage: 'Options copied to clipboard',
                clearConfirmMessage: 'Are you sure you want to clear all options?',
                calculatingMessage: 'Calculating...',
                emptyOptionError: 'Please enter option content',
                optionTooLongError: 'Option content cannot exceed 50 characters',
                duplicateOptionError: 'This option already exists, please enter another option',
                noOptionsToClear: 'No options to clear',
                confirmClearOptions: 'Are you sure you want to clear all options?',
                optionsCleared: 'Options cleared',
                noOptionsToExport: 'No options to export',
                optionsExported: 'Options exported',
                addOptionFirstError: 'Please add at least one option first',
                countTooLowError: 'Random count cannot be less than 1',
                largeCountWarning: 'Too many random selections may cause browser lag, are you sure you want to continue?',
                cacheFoundMessage: 'Found cache result with identical options ({randomCount} random selections)\nOptions: {optionCount} items\nUse cached result?',
                confirmClearCache: 'Are you sure you want to clear all history cache?',
                cacheCleared: 'Cache cleared',
                cacheClearFailed: 'Failed to clear cache',
                noImportHistory: 'No import history',
                cannotLoadImportHistory: 'Cannot load import history',
                importFileProcessing: 'Processing import file...',
                noValidOptionsInImport: 'No valid options found in the imported file',
                invalidImportFormat: 'Imported file format is incorrect, missing options field',
                confirmMergeImportedOptions: 'Merge imported options with existing options?\n{previewMessage}{settingsMessage}',
                confirmMergePastedOptions: 'Merge pasted configuration with existing options?\n{settingsMessage}',
                mergeImportSuccess: 'Successfully imported and merged {newCount} options, currently have {totalCount} options',
                importWithSettingsSuccess: 'Successfully imported {count} options and automatically applied configuration settings',
                importSuccess: 'Successfully imported {count} options',
                pasteSuccessWithSettings: 'Successfully pasted {count} options and automatically applied configuration settings',
                pasteSuccess: 'Successfully pasted {count} options',
                pasteWithMergeSuccess: 'Successfully pasted and merged {newCount} options, currently have {totalCount} options',
                noValidOptionsInPaste: 'No valid options found in pasted content',
                confirmUpdateRandomTimes: 'Update random times setting?',
                fileReadFailed: 'File reading failed, please ensure the file is not corrupted',
                importFileHelp: 'Supports JSON and plain text formats\nJSON format can include complete configuration\nPlain text format: one option per line or separated by commas',
                noCacheHistory: 'No cache history',
                currentResult: 'Current Result',
                clickToRestore: 'Click to Restore',
                olderRecords: '{count} older records available',
                expandCache: 'Expand all records',
                collapseCache: 'Collapse records',
                showAllRecords: 'Show all records',
                hideOlderRecords: 'Hide older records',
                exportFileName: 'RandomSelector_Config',
                importHistoryTitle: 'Import History',
                totalSelectionsLabel: 'Total selections: ',
                optionCountLabel: 'Option count: '
            }
        };
        
        // 多语言支持功能
        let currentLang = 'zh-CN';
        
        function setupLanguageToggle() {
            const langToggle = document.getElementById('langToggle');
            const langText = document.getElementById('langText');
            
            // 检查本地存储中的语言偏好
            const savedLang = localStorage.getItem('language');
            if (savedLang && translations[savedLang]) {
                currentLang = savedLang;
                updateTextContent(currentLang);
            }
            
            // 语言切换事件监听
            langToggle.addEventListener('click', function() {
                // 切换语言
                currentLang = currentLang === 'zh-CN' ? 'en-US' : 'zh-CN';
                
                // 保存到本地存储
                localStorage.setItem('language', currentLang);
                
                // 更新页面文本
                updateTextContent(currentLang);
            });
        }
        
        function updateTextContent(lang) {
            const t = translations[lang];
            
            // 更新页面标题
            document.title = t.pageTitle;
            if (document.getElementById('pageTitle')) {
                document.getElementById('pageTitle').textContent = t.pageTitle;
            }
            
            // 更新语言切换按钮文本
            document.getElementById('langText').textContent = t.langText;
            document.getElementById('langToggle').setAttribute('aria-label', t.langToggleAria);
            document.getElementById('themeToggle').setAttribute('aria-label', t.themeToggleAria);
            
            // 更新页面内容
            if (document.getElementById('headerTitle')) {
                document.getElementById('headerTitle').textContent = t.headerTitle;
            }
            if (document.getElementById('headerSubtitle')) {
                document.getElementById('headerSubtitle').textContent = t.headerSubtitle;
            }
            
            // 使用更可靠的方法更新带图标的标题
            if (document.getElementById('addOptionsTitle')) {
                document.getElementById('addOptionsTitle').innerHTML = `<span class="text-accent mr-2">📋</span>${t.addOptionsTitle}`;
            }
            if (document.getElementById('addOptionsSubtitle')) {
                document.getElementById('addOptionsSubtitle').textContent = t.addOptionsSubtitle;
            }
            
            document.getElementById('singleOptionInput').placeholder = t.optionPlaceholder;
            document.getElementById('addOptionBtn').innerHTML = `<span class="mr-2">+</span>${t.addOptionButton}`;
            
            if (document.getElementById('randomTimesLabel')) {
                document.getElementById('randomTimesLabel').textContent = t.randomTimesLabel;
            }
            const timesUnitElem = document.querySelector('.flex.space-x-2 .bg-gray-50');
            if (timesUnitElem) {
                timesUnitElem.textContent = t.timesUnit;
            }
            
            document.getElementById('exportOptionsBtn').innerHTML = `<span class="mr-1">📥</span>${t.exportOptionsButton}`;
            document.getElementById('importOptionsBtn').innerHTML = `<span class="mr-1">📤</span>${t.importOptionsButton}`;
            document.getElementById('clearOptionsBtn').innerHTML = `<span class="mr-1">🗑️</span>${t.clearButton}`;
            
            document.getElementById('startBtn').innerHTML = `<span class="mr-2">▶️</span>${t.startButton}`;
            
            // 使用更可靠的方法更新带图标的标题
            if (document.getElementById('resultsTitle')) {
                document.getElementById('resultsTitle').innerHTML = `<span class="text-secondary mr-2">📊</span>${t.resultsTitle}`;
            }
            
            if (document.getElementById('emptyOptionsText')) {
                document.getElementById('emptyOptionsText').textContent = t.noOptionsMessage;
            }
            if (document.getElementById('resultsPlaceholder')) {
                document.getElementById('resultsPlaceholder').textContent = t.noResultsMessage;
            }
            
            // 更新使用说明部分
            const useInstructionsTitleElem = document.querySelector('.mt-8 h3');
            if (useInstructionsTitleElem) {
                useInstructionsTitleElem.innerHTML = `<span class="mr-2">ℹ️</span>${t.useInstructionsTitle}`;
            }
            
            const instructions = document.querySelector('.mt-8 ul')?.children || [];
            if (instructions[0]) instructions[0].textContent = t.useInstruction1;
            if (instructions[1]) instructions[1].textContent = t.useInstruction2;
            if (instructions[2]) instructions[2].textContent = t.useInstruction3;
            if (instructions[3]) instructions[3].textContent = t.useInstruction4;
            if (instructions[4]) instructions[4].textContent = t.useInstruction5;
            
            const footerText = document.querySelector('footer p');
            if (footerText) {
                footerText.textContent = t.footerText;
            }
            
            // 更新HTML lang属性
            document.documentElement.lang = lang;
        }
        
        // DOMContentLoaded确保DOM加载完毕
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化主题切换
            setupThemeToggle();
            
            // 初始化语言切换
            setupLanguageToggle();
            
            // 缓存DOM元素引用
            const singleOptionInput = document.getElementById('singleOptionInput');
            const addOptionBtn = document.getElementById('addOptionBtn');
            const optionsList = document.getElementById('optionsList');
            const startBtn = document.getElementById('startBtn');
            const resultsContainer = document.getElementById('resultsContainer');
            const clearOptionsBtn = document.getElementById('clearOptionsBtn');
            const randomTimesInput = document.getElementById('randomTimesInput');
            
            // 存储选项的数组
            let options = [];
            
            // 使用DocumentFragment减少DOM操作
            function createDocumentFragment() {
                return document.createDocumentFragment();
            }

            // 为添加按钮添加点击事件
            addOptionBtn.addEventListener('click', addOption);
            
            // 为输入框添加回车键处理
            singleOptionInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addOption();
                }
            });
            
            // 添加事件委托，处理删除按钮点击
            optionsList.addEventListener('click', (e) => {
                if (e.target.closest('.delete-option-btn')) {
                    const btn = e.target.closest('.delete-option-btn');
                    const index = parseInt(btn.getAttribute('data-index'));
                    deleteOption(index);
                }
            });

            // 添加选项函数
            function addOption() {
                const optionText = singleOptionInput.value.trim();
                
                if (!optionText) {
                    showMessage(t('emptyOptionError'), 'error');
                    return;
                }
                
                // 使用Set快速检查重复（性能优化）
                if (options.includes(optionText)) {
                    showMessage(t('duplicateOptionError'), 'error');
                    return;
                }
                
                // 添加选项到数组
                options.push(optionText);
                
                // 更新选项列表显示
                updateOptionsList();
                
                // 清空输入框
                singleOptionInput.value = '';
                singleOptionInput.focus();
            }
            
            // 更新选项列表显示函数 - 性能优化版本
            function updateOptionsList() {
                // 更新按钮状态
                updateButtonsState();
                
                if (options.length === 0) {
                    optionsList.innerHTML = '<p class="text-gray-500 text-center text-sm py-8">暂无选项，请添加至少两个选项</p>';
                    return;
                }
                
                // 使用DocumentFragment减少DOM重绘
                const fragment = createDocumentFragment();
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'space-y-2';
                
                // 使用模板字符串批量生成HTML，减少DOM操作
                let optionsHtml = '';
                options.forEach((option, index) => {
                    optionsHtml += `
                        <div class="option-item">
                            <div class="flex items-center">
                                <span class="badge badge-primary">${index + 1}</span>
                                <span>${escapeHtml(option)}</span>
                            </div>
                            <button type="button" class="delete-option-btn text-gray-400 hover:text-red-500 transition-all" data-index="${index}">
                                <span>✕</span>
                            </button>
                        </div>
                    `;
                });
                
                optionsContainer.innerHTML = optionsHtml;
                fragment.appendChild(optionsContainer);
                
                // 一次性更新DOM
                optionsList.innerHTML = '';
                optionsList.appendChild(fragment);
            }
            
            // HTML转义函数，防止XSS攻击
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            // 删除选项函数
            function deleteOption(index) {
                options.splice(index, 1);
                updateOptionsList();
            }
            
            // 清空所有选项函数
            function clearAllOptions() {
                if (options.length === 0) {
                    showMessage(t('noOptionsToClear'), 'info');
                    return;
                }
                
                if (confirm(t('confirmClearOptions'))) {
                    options = [];
                    updateOptionsList();
                    showMessage(t('optionsCleared'), 'success');
                    singleOptionInput.focus();
                }
            }
            
            // 为清空按钮添加点击事件
            clearOptionsBtn.addEventListener('click', clearAllOptions);
            
            // 为导出按钮添加点击事件
            exportOptionsBtn.addEventListener('click', exportOptions);
            
            // 为导入按钮添加点击事件
            importOptionsBtn.addEventListener('click', importOptions);
            
            // 为文件输入添加变更事件
            importFileInput.addEventListener('change', handleFileImport);
            
            // 设置粘贴导入功能
            setupPasteImport();
            
            // 更新按钮状态函数
            function updateButtonsState() {
                // 更新清空和导出按钮状态
                const isEmpty = options.length === 0;
                clearOptionsBtn.disabled = isEmpty;
                exportOptionsBtn.disabled = isEmpty;
                
                if (isEmpty) {
                    clearOptionsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    exportOptionsBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    clearOptionsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    exportOptionsBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
            
            // 导出选项函数
            function exportOptions() {
                if (options.length === 0) {
                    showMessage(t('noOptionsToExport'), 'info');
                    return;
                }
                
                // 创建导出数据，包含更多配置信息
                const exportData = {
                    options: options,
                    randomTimes: parseInt(randomTimesInput.value) || 1,
                    exportDate: new Date().toISOString(),
                    version: '1.1',
                    application: '随机选择器',
                    statistics: {
                        optionCount: options.length,
                        characterCount: options.reduce((sum, opt) => sum + opt.length, 0),
                        uniqueCharacters: new Set(options.join('')).size
                    }
                };
                
                // 创建Blob
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                // 创建下载链接
                const a = document.createElement('a');
                a.href = url;
                
                // 生成更具描述性的文件名
                const dateTime = new Date().toLocaleDateString('zh-CN').replace(/\//g, '-') + 
                               '_' + 
                               new Date().toLocaleTimeString('zh-CN', {hour12: false}).replace(/:/g, '-');
                a.download = `随机选择器配置_${options.length}项_${dateTime}.json`;
                document.body.appendChild(a);
                
                // 为下载添加动画效果
                a.style.opacity = '0';
                a.style.pointerEvents = 'none';
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showMessage(t('optionsExported', {count: options.length}), 'info');
            }
            
            // 导入选项函数
            function importOptions() {
                // 显示导入说明
                showMessage('支持 JSON 和纯文本格式\nJSON 格式可包含完整配置\n纯文本格式每行或用逗号分隔一个选项', 'info', 3000);
                
                // 触发文件选择
                setTimeout(() => importFileInput.click(), 500);
            }
            
            // 处理文件导入
            function handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                // 显示加载中状态
                showMessage('正在处理导入文件...', 'info');
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        // 尝试JSON解析
                        const data = JSON.parse(event.target.result);
                        
                        // 验证数据格式
                        if (Array.isArray(data.options)) {
                            // 去重处理
                            const newOptions = [...new Set(data.options)].filter(opt => opt.trim());
                            
                            if (newOptions.length === 0) {
                                showMessage('导入的文件中没有有效的选项', 'error');
                                return;
                            }
                            
                            // 导入预览
                            const previewMessage = `\n检测到 ${newOptions.length} 个选项\n${newOptions.slice(0, 5).join('\n')}${newOptions.length > 5 ? '\n...' : ''}\n`;
                            
                            // 检查是否包含配置信息
                            const hasSettings = data.randomTimes !== undefined;
                            let settingsMessage = '';
                            if (hasSettings) {
                                settingsMessage = `\n同时导入设置: 随机次数 = ${data.randomTimes}`;
                            }
                            
                            // 合并或替换选项
                            const mergeOptions = options.length > 0 ? confirm('是否将导入的选项与现有选项合并？' + previewMessage + settingsMessage) : false;
                            
                            if (mergeOptions) {
                                // 合并并去重
                                const mergedOptions = [...new Set([...options, ...newOptions])];
                                options = mergedOptions;
                                // 如果有设置信息，询问是否更新设置
                                if (hasSettings && confirm('是否更新随机次数设置？')) {
                                    randomTimesInput.value = data.randomTimes;
                                }
                                showMessage(`成功导入并合并 ${newOptions.length} 个选项，当前共有 ${options.length} 个选项`, 'info');
                            } else {
                                // 替换
                                options = newOptions;
                                // 自动应用设置
                                if (hasSettings) {
                                    randomTimesInput.value = data.randomTimes;
                                    showMessage(`成功导入 ${options.length} 个选项，并自动应用配置设置`, 'info');
                                } else {
                                    showMessage(`成功导入 ${options.length} 个选项`, 'info');
                                }
                            }
                            
                            updateOptionsList();
                            
                            // 记录导入历史
                            recordImportHistory({
                                source: 'file',
                                fileName: file.name,
                                count: newOptions.length,
                                timestamp: new Date().toISOString()
                            });
                        } else {
                            showMessage('导入的文件格式不正确，缺少options字段', 'error');
                        }
                    } catch (error) {
                        // 尝试纯文本格式（支持多种分隔符）
                        try {
                            const textContent = event.target.result;
                            // 支持多种分隔符：换行、逗号、分号、制表符
                            const textOptions = textContent
                                .split(/[\r\n,;\t]/)
                                .map(opt => opt.trim())
                                .filter(opt => opt);
                            
                            if (textOptions.length === 0) {
                                showMessage('导入的文件中没有有效的选项', 'error');
                                return;
                            }
                            
                            // 去重
                            const newOptions = [...new Set(textOptions)];
                            
                            // 导入预览
                            const previewMessage = `\n检测到 ${newOptions.length} 个选项\n${newOptions.slice(0, 5).join('\n')}${newOptions.length > 5 ? '\n...' : ''}\n`;
                            
                            // 合并或替换选项
                            const mergeOptions = options.length > 0 ? confirm('是否将导入的选项与现有选项合并？' + previewMessage) : false;
                            
                            if (mergeOptions) {
                                const mergedOptions = [...new Set([...options, ...newOptions])];
                                options = mergedOptions;
                                showMessage(`成功导入并合并 ${newOptions.length} 个选项，当前共有 ${options.length} 个选项`, 'info');
                            } else {
                                options = newOptions;
                                showMessage(`成功导入 ${options.length} 个选项`, 'info');
                            }
                            
                            updateOptionsList();
                            
                            // 记录导入历史
                            recordImportHistory({
                                source: 'text_file',
                                fileName: file.name,
                                count: newOptions.length,
                                timestamp: new Date().toISOString()
                            });
                        } catch (textError) {
                            showMessage('导入失败，请检查文件格式是否正确。支持JSON格式或用逗号/换行分隔的文本格式。', 'error');
                        }
                    }
                };
                
                reader.onerror = function() {
                    showMessage('文件读取失败，请确保文件未被损坏', 'error');
                };
                
                // 读取文件
                reader.readAsText(file);
                
                // 清空文件输入，允许重复导入相同文件
                e.target.value = '';
            }
            
            // 记录导入历史
            function recordImportHistory(importInfo) {
                try {
                    let importHistory = JSON.parse(localStorage.getItem('randomSelectorImportHistory') || '[]');
                    importHistory.unshift(importInfo);
                    // 只保留最近5条历史记录
                    if (importHistory.length > 5) {
                        importHistory = importHistory.slice(0, 5);
                    }
                    localStorage.setItem('randomSelectorImportHistory', JSON.stringify(importHistory));
                } catch (e) {
                    // 静默失败，不影响主要功能
                }
            }
            
            // 显示导入历史
            function showImportHistory() {
                try {
                    const importHistory = JSON.parse(localStorage.getItem('randomSelectorImportHistory') || '[]');
                    if (importHistory.length === 0) {
                        showMessage(t('noImportHistory'), 'info');
                        return;
                    }
                    
                    const historyMessage = importHistory.map((item, index) => {
                        const date = new Date(item.timestamp).toLocaleString(getCurrentLocale());
                        const sourceType = item.source === 'file' ? t('fileSource') : item.source === 'text_file' ? t('textFileSource') : t('pasteSource');
                        return `${index + 1}. ${date}: ${t('importFrom')}${sourceType}${t('import')} ${item.count} ${t('options')}${item.fileName ? ' (' + item.fileName + ')' : ''}`;
                    }).join('\n');
                    
                    showMessage(t('importHistoryTitle') + ':\n' + historyMessage, 'info', 5000);
                } catch (e) {
                    showMessage(t('cannotLoadImportHistory'), 'error');
                }
            }
            
            // 粘贴导入功能 - 增强版
            function setupPasteImport() {
                singleOptionInput.addEventListener('paste', function(e) {
                    // 获取粘贴内容
                    const pastedText = e.clipboardData.getData('text');
                    
                    // 尝试识别是否为JSON配置
                    let isJsonConfig = false;
                    try {
                        const parsed = JSON.parse(pastedText);
                        isJsonConfig = parsed.options && Array.isArray(parsed.options);
                    } catch (e) {
                        // 不是JSON，继续处理
                    }
                    
                    // 如果是JSON配置或多行/多逗号内容，触发特殊处理
                    if (isJsonConfig || (pastedText.includes('\n') || pastedText.includes(',') || pastedText.includes(';'))) {
                        e.preventDefault();
                        
                        if (isJsonConfig) {
                            // 处理JSON配置
                            const data = JSON.parse(pastedText);
                            const newOptions = [...new Set(data.options)].filter(opt => opt.trim());
                            
                            if (newOptions.length === 0) {
                                showMessage('粘贴的内容中没有有效的选项', 'error');
                                return;
                            }
                            
                            const hasSettings = data.randomTimes !== undefined;
                            let settingsMessage = '';
                            if (hasSettings) {
                                settingsMessage = `\n同时导入设置: 随机次数 = ${data.randomTimes}`;
                            }
                            
                            // 合并或替换选项
                            const mergeOptions = options.length > 0 ? confirm('是否将粘贴的配置与现有选项合并？' + settingsMessage) : false;
                            
                            if (mergeOptions) {
                                // 合并并去重
                                const mergedOptions = [...new Set([...options, ...newOptions])];
                                options = mergedOptions;
                                // 如果有设置信息，询问是否更新设置
                                if (hasSettings && confirm('是否更新随机次数设置？')) {
                                    randomTimesInput.value = data.randomTimes;
                                }
                                showMessage(`成功粘贴并合并 ${newOptions.length} 个选项，当前共有 ${options.length} 个选项`, 'info');
                            } else {
                                // 替换
                                options = newOptions;
                                // 自动应用设置
                                if (hasSettings) {
                                    randomTimesInput.value = data.randomTimes;
                                    showMessage(`成功粘贴 ${options.length} 个选项，并自动应用配置设置`, 'info');
                                } else {
                                    showMessage(`成功粘贴 ${options.length} 个选项`, 'info');
                                }
                            }
                        } else {
                            // 解析粘贴的文本内容，支持更多分隔符
                            const pastedOptions = pastedText
                                .split(/[\r\n,;\t]/)
                                .map(opt => opt.trim())
                                .filter(opt => opt);
                            
                            if (pastedOptions.length > 1) {
                                // 导入预览
                                const preview = pastedOptions.slice(0, 3).join('\n');
                                const previewMessage = pastedOptions.length > 3 ? `${preview}\n... 等共 ${pastedOptions.length} 个选项` : preview;
                                
                                const confirmImport = confirm(`检测到多个选项:\n${previewMessage}\n\n是否作为多个选项导入？`);
                                if (confirmImport) {
                                    // 去重
                                    const newOptions = [...new Set(pastedOptions)];
                                    
                                    // 合并或替换
                                    const mergeOptions = options.length > 0 && confirm('是否将粘贴的选项与现有选项合并？');
                                    
                                    if (mergeOptions) {
                                        const mergedOptions = [...new Set([...options, ...newOptions])];
                                        options = mergedOptions;
                                        showMessage(`成功粘贴并合并 ${newOptions.length} 个选项，当前共有 ${options.length} 个选项`, 'info');
                                    } else {
                                        options = newOptions;
                                        showMessage(`成功粘贴 ${options.length} 个选项`, 'info');
                                    }
                                } else {
                                    // 如果用户取消导入，则正常粘贴
                                    singleOptionInput.value = pastedText;
                                    return;
                                }
                            } else if (pastedOptions.length === 1) {
                                // 单个选项，正常粘贴
                                singleOptionInput.value = pastedOptions[0];
                                return;
                            }
                        }
                        
                        updateOptionsList();
                        
                        // 记录导入历史
                        recordImportHistory({
                            source: isJsonConfig ? 'pasted_config' : 'paste',
                            count: pastedOptions?.length || data.options.length,
                            timestamp: new Date().toISOString()
                        });
                    }
                });
            }

        // 为开始按钮添加点击事件
            startBtn.addEventListener('click', async () => {
                // 检查选项数量
                if (options.length < 2) {
                    showMessage(t('emptyOptionsMessage'), 'error');
                    return;
                }
                
                // 获取并验证随机次数
                let randomTimes = parseInt(randomTimesInput.value);
                
                // 验证输入
                if (isNaN(randomTimes) || randomTimes < 1) {
                    showMessage(t('countTooLowError'), 'error');
                    randomTimesInput.value = 100;
                    return;
                }
                
                // 限制最大值
                if (randomTimes > 10000) {
                    if (confirm(t('largeCountWarning'))) {
                        randomTimes = 10000;
                        randomTimesInput.value = 10000;
                    } else {
                        return;
                    }
                }

                // 添加加载状态
                startBtn.disabled = true;
                let originalText = startBtn.innerHTML;
                startBtn.innerHTML = `<span class="mr-2">⏳</span>${t('calculatingMessage')}`;
                
                try {
                    // 对于大批量数据，显示处理进度
                    if (randomTimes > 2000) {
                        // 显示进度指示器
                        resultsContainer.innerHTML = `
                            <div class="flex flex-col items-center justify-center py-12">
                                <div class="text-5xl mb-4">🔄</div>
                                <p class="text-gray-600 mb-4">${t('calculatingMessage')}</p>
                                <div class="w-full max-w-sm bg-gray-200 rounded-full h-2.5">
                                    <div id="processProgress" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
                                </div>
                            </div>
                        `;
                    }
                    
                    // 使用内联Web Worker处理大量随机计算
                    function optimizedRandomSelectWithProgress(options, times) {
                        return new Promise((resolve, reject) => {
                            try {
                                // 创建内联Web Worker，包含增强版随机算法
                                const workerCode = `
                                    // 获取加密安全的随机数
                                    function getSecureRandom() {
                                        const array = new Uint8Array(1);
                                        crypto.getRandomValues(array);
                                        return array[0] / 255; // 归一化到0-1范围
                                    }
                                    
                                    // Fisher-Yates 洗牌算法
                                    function shuffleArray(array) {
                                        const result = [...array];
                                        for (let i = result.length - 1; i > 0; i--) {
                                            const j = Math.floor(getSecureRandom() * (i + 1));
                                            [result[i], result[j]] = [result[j], result[i]];
                                        }
                                        return result;
                                    }
                                    
                                    // 增强版随机选择函数
                                    function randomSelect(options, times, weights = null) {
                                        const optionsLength = options.length;
                                        
                                        // 初始化权重数组（默认为等权重）
                                        const effectiveWeights = weights && weights.length === optionsLength ? 
                                            weights : new Array(optionsLength).fill(1);
                                        
                                        // 计算权重总和
                                        const totalWeight = effectiveWeights.reduce((sum, weight) => sum + weight, 0);
                                        
                                        // 初始化计数数组
                                        const countArray = new Array(optionsLength).fill(0);
                                        
                                        // 分批处理以避免阻塞并报告进度
                                        let processedTimes = 0;
                                        const batchSize = 10000;
                                        
                                        while (processedTimes < times) {
                                            const currentBatchSize = Math.min(batchSize, times - processedTimes);
                                            
                                            if (currentBatchSize > 1000) {
                                                // 大批量使用洗牌算法提高公平性
                                                // 创建权重数组
                                                const weightedOptions = [];
                                                for (let i = 0; i < optionsLength; i++) {
                                                    const weight = effectiveWeights[i];
                                                    const weightFactor = Math.max(1, Math.floor(weight * 10));
                                                    for (let j = 0; j < weightFactor; j++) {
                                                        weightedOptions.push(i); // 存储索引
                                                    }
                                                }
                                                
                                                // 洗牌
                                                const shuffledIndices = shuffleArray(weightedOptions);
                                                
                                                // 从洗牌后的数组中选择
                                                for (let i = 0; i < currentBatchSize; i++) {
                                                    const selectedIndex = shuffledIndices[Math.floor(getSecureRandom() * shuffledIndices.length)];
                                                    countArray[selectedIndex]++;
                                                }
                                            } else {
                                                // 小批量使用加权随机选择
                                                for (let i = 0; i < currentBatchSize; i++) {
                                                    const randomValue = getSecureRandom() * totalWeight;
                                                    let cumulativeWeight = 0;
                                                    let selectedIndex = 0;
                                                    
                                                    for (let j = 0; j < optionsLength; j++) {
                                                        cumulativeWeight += effectiveWeights[j];
                                                        if (randomValue < cumulativeWeight) {
                                                            selectedIndex = j;
                                                            break;
                                                        }
                                                    }
                                                    
                                                    countArray[selectedIndex]++;
                                                }
                                            }
                                            
                                            // 更新已处理次数
                                            processedTimes += currentBatchSize;
                                            
                                            // 计算并发送进度
                                            const progress = (processedTimes / times) * 100;
                                            self.postMessage({ type: 'progress', progress: progress });
                                        }
                                        
                                        // 构建结果对象
                                        const finalResults = {};
                                        for (let i = 0; i < optionsLength; i++) {
                                            finalResults[options[i]] = countArray[i];
                                        }
                                        
                                        return finalResults;
                                    }
                                    
                                    // 监听主线程消息
                                    self.addEventListener('message', function(e) {
                                        const { options, times, weights } = e.data;
                                        
                                        try {
                                            const results = randomSelect(options, times, weights);
                                            self.postMessage({ type: 'result', results: results });
                                        } catch (error) {
                                            console.error('Worker计算错误:', error);
                                            self.postMessage({ type: 'error', error: error.message });
                                        } finally {
                                            // 完成后关闭Worker
                                            self.close();
                                        }
                                    });
                                `;
                                
                                const worker = new Worker(URL.createObjectURL(new Blob([workerCode], { type: 'application/javascript' })));
                                
                                // 监听Worker消息
                                worker.addEventListener('message', function(e) {
                                    const { type, progress, results, error } = e.data;
                                    
                                    if (type === 'progress') {
                                        // 更新进度条
                                        if (randomTimes > 2000) {
                                            const progressBar = document.getElementById('processProgress');
                                            if (progressBar) {
                                                progressBar.style.width = `${Math.min(99, progress)}%`;
                                            }
                                        }
                                    } else if (type === 'result') {
                                        // 计算完成，关闭Worker并返回结果
                                        worker.terminate();
                                        resolve(results);
                                    } else if (type === 'error') {
                                        console.error('Worker计算错误:', error);
                                        worker.terminate();
                                        // 回退到主线程处理
                                        console.warn('Worker内部错误，回退到主线程计算');
                                        resolve(randomSelect(options, times));
                                    }
                                });
                                
                                // 监听错误
                                worker.addEventListener('error', function(error) {
                                    console.error('Worker错误:', error);
                                    worker.terminate();
                                    
                                    // 回退到主线程处理
                                    console.warn('Web Worker失败，回退到主线程计算');
                                    const fallbackResult = randomSelect(options, times);
                                    resolve(fallbackResult);
                                });
                                
                                // 发送数据到Worker开始计算
                                worker.postMessage({ options, times, weights: null });
                                
                                // 超时处理
                                setTimeout(() => {
                                    worker.terminate();
                                    console.warn('Worker计算超时，回退到主线程');
                                    resolve(randomSelect(options, times));
                                }, 30000); // 30秒超时
                                
                            } catch (error) {
                                console.error('创建Web Worker失败:', error);
                                // 回退到主线程处理
                                console.warn('Web Worker不可用，使用主线程计算');
                                resolve(randomSelect(options, times));
                            }
                        });
                    }
                    
                    // 跳过缓存检查和提示，直接执行随机选择
                    // 如需恢复缓存提示，请取消注释下方代码
                    /*
                    const cachedResult = cacheManager.findSimilar(options);
                    if (cachedResult && randomTimes <= 2000) {
                        const useCache = confirm(
                            t('cacheFoundMessage', {
                                randomCount: cachedResult.totalSelections,
                                optionCount: cachedResult.optionCount
                            })
                        );
                        
                        if (useCache) {
                            displayResults(cachedResult.results, cachedResult.totalSelections, cachedResult.id);
                            return;
                        }
                    }
                    */
                
                // 执行随机选择
                let results;
                if (randomTimes <= 2000) {
                    // 小批量数据直接使用已优化的同步函数
                    results = randomSelect(options, randomTimes);
                } else {
                    // 大批量数据使用带进度的异步函数
                    results = await optimizedRandomSelectWithProgress(options, randomTimes);
                }
                
                // 显示结果
                displayResults(results, randomTimes);
                } finally {
                    // 无论成功或失败，都恢复按钮状态
                    startBtn.disabled = false;
                    startBtn.innerHTML = originalText;
                }
            });

        // 获取加密安全的随机数
        function getSecureRandom() {
            if (window.crypto && window.crypto.getRandomValues) {
                const array = new Uint8Array(1);
                window.crypto.getRandomValues(array);
                return array[0] / 255; // 归一化到0-1范围
            }
            // 回退方案：结合时间戳提高Math.random()的随机性
            const timeBasedSeed = Date.now() % 1000 / 1000;
            const mathRandom = Math.random();
            return (mathRandom + timeBasedSeed) % 1;
        }
        
        // Fisher-Yates 洗牌算法
        function shuffleArray(array) {
            const result = [...array];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(getSecureRandom() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }
        
        // 带权重的随机选择函数 - 增强公平性版本
        function randomSelect(options, times, weights = null) {
            const optionsLength = options.length;
            
            // 初始化权重数组（默认为等权重）
            const effectiveWeights = weights && weights.length === optionsLength ? 
                weights : new Array(optionsLength).fill(1);
            
            // 计算权重总和
            const totalWeight = effectiveWeights.reduce((sum, weight) => sum + weight, 0);
            
            // 初始化计数数组
            const countArray = new Array(optionsLength).fill(0);
            
            // 对于大量随机选择，使用洗牌算法提高公平性
            if (times > 1000) {
                // 批量处理，每批次洗牌后选择
                const batchSize = Math.min(1000, times);
                let remainingTimes = times;
                
                while (remainingTimes > 0) {
                    const currentBatchSize = Math.min(batchSize, remainingTimes);
                    
                    // 创建权重数组（根据权重复制选项）
                    const weightedOptions = [];
                    for (let i = 0; i < optionsLength; i++) {
                        const weight = effectiveWeights[i];
                        // 对于权重较大的选项，将其添加到数组中多次
                        // 这里使用简化版本，真实应用中可能需要更精确的权重处理
                        const weightFactor = Math.max(1, Math.floor(weight * 10));
                        for (let j = 0; j < weightFactor; j++) {
                            weightedOptions.push(i); // 存储索引而不是选项文本
                        }
                    }
                    
                    // 洗牌
                    const shuffledIndices = shuffleArray(weightedOptions);
                    
                    // 从洗牌后的数组中选择
                    for (let i = 0; i < currentBatchSize; i++) {
                        const selectedIndex = shuffledIndices[Math.floor(getSecureRandom() * shuffledIndices.length)];
                        countArray[selectedIndex]++;
                    }
                    
                    remainingTimes -= currentBatchSize;
                }
            } else {
                // 对于少量随机选择，使用加权随机选择
                for (let i = 0; i < times; i++) {
                    // 使用加权随机选择算法
                    const randomValue = getSecureRandom() * totalWeight;
                    let cumulativeWeight = 0;
                    let selectedIndex = 0;
                    
                    for (let j = 0; j < optionsLength; j++) {
                        cumulativeWeight += effectiveWeights[j];
                        if (randomValue < cumulativeWeight) {
                            selectedIndex = j;
                            break;
                        }
                    }
                    
                    countArray[selectedIndex]++;
                }
            }
            
            // 构建结果对象
            const finalResults = {};
            for (let i = 0; i < optionsLength; i++) {
                finalResults[options[i]] = countArray[i];
            }
            
            return finalResults;
        }

        // 缓存管理器
        const cacheManager = {
            MAX_CACHE_ITEMS: 10,
            
            // 保存结果到缓存
            saveResult: function(results, options, totalSelections) {
                try {
                    // 创建缓存项
                    const cacheItem = {
                        id: Date.now(),
                        timestamp: new Date().toLocaleString(),
                        options: [...options], // 保存原始选项
                        results: { ...results },
                        totalSelections
                    };
                    
                    // 获取现有缓存
                    const cache = this.getCache();
                    
                    // 添加新项到开头
                    cache.unshift(cacheItem);
                    
                    // 限制缓存大小
                    if (cache.length > this.MAX_CACHE_ITEMS) {
                        cache.splice(this.MAX_CACHE_ITEMS);
                    }
                    
                    // 保存到localStorage
                    localStorage.setItem('random-selector-cache', JSON.stringify(cache));
                    
                    return cacheItem.id;
                } catch (error) {
                    console.error('保存缓存失败:', error);
                    return null;
                }
            },
            
            // 获取所有缓存
            getCache: function() {
                try {
                    const cacheStr = localStorage.getItem('random-selector-cache');
                    return cacheStr ? JSON.parse(cacheStr) : [];
                } catch (error) {
                    console.error('读取缓存失败:', error);
                    return [];
                }
            },
            
            // 通过ID获取缓存
            getById: function(id) {
                const cache = this.getCache();
                return cache.find(item => item.id === id) || null;
            },
            
            // 清除所有缓存
            clearCache: function() {
                try {
                    localStorage.removeItem('random-selector-cache');
                    return true;
                } catch (error) {
                    console.error('清除缓存失败:', error);
                    return false;
                }
            },
            
            // 根据当前选项查找相似的缓存
            findSimilar: function(currentOptions) {
                const cache = this.getCache();
                
                // 选项集合的比较函数
                const optionsMatch = (opts1, opts2) => {
                    if (opts1.length !== opts2.length) return false;
                    const set1 = new Set(opts1);
                    const set2 = new Set(opts2);
                    return [...set1].every(opt => set2.has(opt));
                };
                
                return cache.find(item => optionsMatch(item.options, currentOptions));
            }
        };
        
        // 显示结果函数 - 性能优化版本（带缓存功能）
        function displayResults(results, totalSelections, cacheId = null) {
            // 保存结果到缓存
            if (!cacheId) {
                cacheId = cacheManager.saveResult(results, options, totalSelections);
            }
            
            // 使用DocumentFragment减少DOM重绘
            const fragment = document.createDocumentFragment();
            
            // 将结果转换为数组并按次数排序
            const sortedResults = Object.entries(results)
                .sort((a, b) => b[1] - a[1]);
            
            // 创建结果容器
            const resultsWrapper = document.createElement('div');
            resultsWrapper.className = 'space-y-5 w-full';
            
            // 添加统计摘要和缓存操作
            const summaryCard = document.createElement('div');
            summaryCard.className = 'p-4 rounded-lg border border-gray-100';
            summaryCard.style.backgroundColor = 'var(--card-background)';
            summaryCard.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">${t('totalSelectionsLabel')}</span>
                    <span class="font-semibold text-primary">${totalSelections}${t('timesUnit')}</span>
                </div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-gray-600">${t('optionCountLabel')}</span>
                    <span class="font-semibold text-primary">${sortedResults.length}${t('timesUnit')}</span>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <div class="text-sm text-gray-500">
                        <span id="cacheTimestamp">${new Date().toLocaleString()}</span>
                        ${cacheId ? `<span class="ml-2">（已缓存）</span>` : ''}
                    </div>
                    <button id="clearCacheBtn" class="text-sm px-3 py-1 rounded hover:bg-gray-200 transition-colors">
                        ${t('confirmClearCache')}
                    </button>
                </div>`;
            resultsWrapper.appendChild(summaryCard);
            
            // 添加缓存历史区域 - 使用最基础的JavaScript语法
            var cacheHistorySection = document.createElement('div');
            cacheHistorySection.className = 'p-4 rounded-lg border border-gray-100';
            cacheHistorySection.style.backgroundColor = 'var(--card-background)';
            
            // 缓存展开状态 - 使用简单的变量
            var isCacheExpanded = false;
            
            // 简单的切换函数 - 专门用于处理按钮点击
            function toggleCacheDisplay() {
                isCacheExpanded = !isCacheExpanded;
                displayCacheHistory();
                bindCacheItemEvents();
            }
            
            // 显示缓存历史 - 使用最基础的JS语法
            function displayCacheHistory() {
                var cacheItems = cacheManager.getCache();
                
                if (cacheItems.length === 0) {
                    // 没有缓存记录的简单情况
                    cacheHistorySection.innerHTML = '';
                    var h3 = document.createElement('h3');
                    h3.className = 'font-medium mb-2';
                    h3.textContent = t('importHistoryTitle');
                    cacheHistorySection.appendChild(h3);
                    
                    var p = document.createElement('p');
                    p.className = 'text-gray-500 text-sm';
                    p.textContent = t('noCacheHistory');
                    cacheHistorySection.appendChild(p);
                    return;
                }
                
                // 清空现有内容
                cacheHistorySection.innerHTML = '';
                
                // 创建头部容器
                var header = document.createElement('div');
                header.className = 'flex justify-between items-center mb-3';
                
                // 添加标题
                var title = document.createElement('h3');
                title.className = 'font-medium';
                title.textContent = t('importHistoryTitle');
                header.appendChild(title);
                
                // 如果有超过3条记录，添加切换按钮
                if (cacheItems.length > 3) {
                    var toggleBtn = document.createElement('button');
                    toggleBtn.id = 'toggleCacheBtn';
                    toggleBtn.className = 'text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 transition-colors';
                    // 根据状态设置按钮文本
                    if (isCacheExpanded) {
                        toggleBtn.textContent = t('hideOlderRecords');
                    } else {
                        toggleBtn.textContent = t('showAllRecords');
                    }
                    // 直接绑定点击事件
                    toggleBtn.onclick = toggleCacheDisplay;
                    header.appendChild(toggleBtn);
                }
                
                cacheHistorySection.appendChild(header);
                
                // 创建内容容器
                var contentContainer = document.createElement('div');
                contentContainer.className = 'space-y-2';
                
                // 根据展开状态决定显示数量
                var displayCount;
                if (isCacheExpanded) {
                    displayCount = cacheItems.length;
                } else {
                    displayCount = 3;
                }
                
                // 添加缓存记录项
                for (var i = 0; i < displayCount; i++) {
                    if (i >= cacheItems.length) break;
                    
                    var item = cacheItems[i];
                    var cacheDiv = document.createElement('div');
                    var isCurrentClass = '';
                    if (item.id === cacheId) {
                        isCurrentClass = ' bg-gray-100';
                    }
                    cacheDiv.className = 'cache-item' + isCurrentClass + ' p-2 rounded cursor-pointer hover:bg-gray-50 transition-colors';
                    
                    // 计算结果数量
                    var resultCount = 0;
                    for (var key in item.results) {
                        if (item.results.hasOwnProperty(key)) {
                            resultCount += item.results[key];
                        }
                    }
                    
                    // 第一行：时间戳和状态
                    var topRow = document.createElement('div');
                    topRow.className = 'flex justify-between items-center';
                    
                    var timeSpan = document.createElement('span');
                    timeSpan.className = 'text-sm';
                    timeSpan.textContent = item.timestamp;
                    topRow.appendChild(timeSpan);
                    
                    var statusSpan = document.createElement('span');
                    statusSpan.className = 'text-xs px-2 py-1 rounded';
                    if (item.id === cacheId) {
                        statusSpan.className += ' bg-primary text-white';
                        statusSpan.textContent = t('currentResult');
                    } else {
                        statusSpan.className += ' bg-gray-200';
                        statusSpan.textContent = t('clickToRestore');
                    }
                    topRow.appendChild(statusSpan);
                    
                    // 第二行：选项和次数
                    var bottomRow = document.createElement('div');
                    bottomRow.className = 'flex justify-between items-center mt-1 text-xs text-gray-500';
                    
                    var optionsSpan = document.createElement('span');
                    optionsSpan.textContent = '选项: ' + item.options.length + '个';
                    bottomRow.appendChild(optionsSpan);
                    
                    var countSpan = document.createElement('span');
                    countSpan.textContent = '随机次数: ' + resultCount + '次';
                    bottomRow.appendChild(countSpan);
                    
                    // 组装缓存项
                    cacheDiv.appendChild(topRow);
                    cacheDiv.appendChild(bottomRow);
                    
                    contentContainer.appendChild(cacheDiv);
                }
                
                cacheHistorySection.appendChild(contentContainer);
                
                // 如果未展开且有更多记录，显示提示
                if (!isCacheExpanded && cacheItems.length > 3) {
                    var moreHint = document.createElement('p');
                    moreHint.className = 'text-xs text-gray-500 mt-2';
                    // 避免复杂语法，直接传递对象
                    var countObj = {count: cacheItems.length - 3};
                    moreHint.textContent = t('olderRecords', countObj);
                    cacheHistorySection.appendChild(moreHint);
                }
            }
            
            // 绑定缓存项点击事件的函数，避免重复绑定
            const bindCacheItemEvents = () => {
                setTimeout(() => {
                    const cacheItems = document.querySelectorAll('.cache-item');
                    cacheItems.forEach(item => {
                        // 先移除可能存在的事件监听器
                        const newItem = item.cloneNode(true);
                        item.parentNode.replaceChild(newItem, item);
                        
                        newItem.addEventListener('click', function() {
                            // 找到对应缓存
                            const cacheItems = cacheManager.getCache();
                            const cacheItem = cacheItems.find(c => 
                                c.timestamp === this.querySelector('.text-sm').textContent
                            );
                            
                            if (cacheItem) {
                                // 恢复缓存结果
                                displayResults(cacheItem.results, cacheItem.totalSelections, cacheItem.id);
                            }
                        });
                    });
                }, 10); // 稍微延迟以确保DOM已更新
            };
            
            // 初始化显示缓存历史
            displayCacheHistory();
            resultsWrapper.appendChild(cacheHistorySection);
            
            // 批量生成结果HTML，减少DOM操作
            let resultsHtml = '';
            sortedResults.forEach(([option, count], index) => {
                const percentage = ((count / totalSelections) * 100).toFixed(1);
                
                // 根据排名设置不同的进度条颜色和徽章样式
                let barColor = 'bg-primary';
                let badgeClass = 'badge-gray';
                
                if (index === 0) {
                    barColor = 'bg-gradient-primary';
                    badgeClass = 'badge-gold';
                } else if (index === 1) {
                    barColor = 'bg-secondary';
                    badgeClass = 'badge-silver';
                } else if (index === 2) {
                    barColor = 'bg-accent';
                    badgeClass = 'badge-bronze';
                }
                
                resultsHtml += `
                    <div class="result-item">
                        <div class="flex justify-between mb-2">
                            <div class="flex items-center">
                                <span class="badge ${badgeClass}">${index + 1}</span>
                                <span class="font-medium">${escapeHtml(option)}</span>
                            </div>
                            <span class="font-semibold">${count}次 <span class="text-primary">(${percentage}%)</span></span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill ${barColor}" style="width: 0%" data-percent="${percentage}"></div>
                        </div>
                    </div>
                `;
            });
            
            const resultsList = document.createElement('div');
            resultsList.className = 'space-y-4';
            resultsList.innerHTML = resultsHtml;
            resultsWrapper.appendChild(resultsList);
            
            fragment.appendChild(resultsWrapper);
            
            // 一次性更新DOM
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(fragment);
            
            // 触发进度条动画，使用requestAnimationFrame确保DOM已更新
            requestAnimationFrame(() => {
                const progressBars = document.querySelectorAll('.result-item .progress-fill[data-percent]');
                progressBars.forEach((bar, index) => {
                    // 为每个进度条添加一点延迟，创建级联效果
                    setTimeout(() => {
                        bar.style.width = `${bar.dataset.percent}%`;
                    }, index * 100);
                });
            });
            
            // 清除缓存按钮事件监听
            const clearCacheBtn = document.getElementById('clearCacheBtn');
            if (clearCacheBtn) {
                clearCacheBtn.addEventListener('click', function() {
                    if (confirm(t('confirmClearCache'))) {
                        if (cacheManager.clearCache()) {
                            showMessage(t('cacheCleared'), 'info');
                            
                            // 重新加载页面以重置所有状态
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            showMessage(t('cacheClearFailed'), 'error');
                        }
                    }
                });
            }
            
            // 使用新的缓存项事件绑定函数
            bindCacheItemEvents();
        }

        // 获取当前语言的翻译
        function t(key, params = {}) {
            let text = translations[currentLang][key] || key;
            // 替换参数
            Object.keys(params).forEach(param => {
                text = text.replace(new RegExp(`\\{${param}\\}`, 'g'), params[param]);
            });
            return text;
        }
        
        // 显示消息函数
        function showMessage(text, type = 'info') {
            // 使用DocumentFragment减少DOM操作
            const fragment = document.createDocumentFragment();
            
            const messageBox = document.createElement('div');
            messageBox.className = `p-4 rounded-lg text-center transition-all duration-300 transform animate-fadeIn ${type === 'error' ? 'message-error shadow-sm' : 'message-info shadow-sm'}`;
            
            messageBox.innerHTML = `
                <span class="mr-2">${type === 'error' ? '⚠️' : 'ℹ️'}</span>
                ${text}
            `;
            
            fragment.appendChild(messageBox);
            
            // 一次性更新DOM
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(fragment);
        }
    }); // DOMContentLoaded结束


    </script>
</body>
</html>
